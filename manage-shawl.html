<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Shawls | Kashur Shawl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="manage-products.css">
</head>

  <style type="text/css">
    :root {
  --glass-bg: #081830BF;
  --blur: blur(14px);
  --heading-text: #ffffff;
  --body-text: #dfe0f0;
  --accent: #ffffff;
}

/* RESET */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}

body {
  background: #020617;
  color: var(--heading-text);
  min-height: 100vh;
}

/* PAGE */
.container {
  max-width: 420px;
  margin: auto;
  padding: 30px 16px;
}

/* PRODUCT CARD */
.product-card {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  border-radius: 18px;
  padding: 16px;
  margin-bottom: 18px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
}

.product-card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 12px;
}

.product-info h3 {
  font-size: 16px;
}

.product-info p {
  font-size: 14px;
  color: var(--body-text);
}

/* ACTIONS */
.actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

.actions button {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  font-size: 13px;
  cursor: pointer;
}

.edit-btn {
  background: var(--accent);
  color: #020617;
}

.delete-btn {
  background: #ff6b6b;
  color:rgba(255, 250, 250, 1) ;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

/* MODAL */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.92);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal.active {
  display: flex;
}

.modal-box {
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  padding: 22px;
  border-radius: 18px;
  width: 90%;
  max-width: 360px;
}

.modal-box h3 {
  margin-bottom:20px;
}

.modal-box img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 10px;
}

.modal-box input {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.25);
  background: transparent;
  color: var(--heading-text);
}

.modal-actions {
  display: flex;
  gap: 10px;
}

.modal-actions button {
  flex: 1;
  padding: 11px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
}

.save-btn {
  background: var(--accent);
  color: #020617;
}

.cancel-btn {
  background: transparent;
  color: var(--heading-text);
  border: 1px solid rgba(255, 255, 255, 0.35);
}

/* ALERT */
.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--glass-bg);
  backdrop-filter: var(--blur);
  padding: 14px 18px;
  border-radius: 12px;
  display: none;
  z-index: 1000;
}

.alert.show {
  display: block;
}
  </style>

<body>

<div class="container" id="productList"></div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
  <div class="modal-box">
    <h3>Edit Shawl</h3>

    <img id="previewImg" alt="Preview">

    <input type="text" id="editName" placeholder="Shawl Name">
    <input type="number" id="editPrice" placeholder="Price">

    <div class="modal-actions">
      <button class="save-btn" onclick="saveEdit()">Save</button>
      <button class="cancel-btn" onclick="closeEdit()">Cancel</button>
    </div>
  </div>
</div>

<div id="alert" class="alert"></div>

<script type="module">
  /* ---------------- FIREBASE ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    deleteDoc,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
  import {
    getFunctions,
    httpsCallable
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
  
  /* üî• FIREBASE CONFIG */
  const firebaseConfig = {
    apiKey: "AIzaSyBj3xo_prL6jkqXb4tTvJTu6yp2hsutuCQ",
    authDomain: "kashur-shawl.firebaseapp.com",
    projectId: "kashur-shawl",
    storageBucket: "kashur-shawl.appspot.com",
    messagingSenderId: "491337394878",
    appId: "1:491337394878:web:511efd29a93fd2608e4cef"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const functions = getFunctions(app);
  
  /* ---------------- UI ELEMENTS ---------------- */
  const list = document.getElementById("productList");
  const editModal = document.getElementById("editModal");
  const alertBox = document.getElementById("alert");
  
  const editName = document.getElementById("editName");
  const editPrice = document.getElementById("editPrice");
  const previewImg = document.getElementById("previewImg");
  
  let currentId = null;
  let currentPublicId = null;
  
  /* ---------------- ALERT ---------------- */
  function showAlert(msg) {
    alertBox.textContent = msg;
    alertBox.classList.add("show");
    setTimeout(() => alertBox.classList.remove("show"), 3000);
  }
  
  /* ---------------- LOAD PRODUCTS ---------------- */
  async function loadProducts() {
    list.innerHTML = "";
    
    const snapshot = await getDocs(collection(db, "products"));
    
    snapshot.forEach(docSnap => {
      const p = docSnap.data();
      
      list.innerHTML += `
      <div class="product-card">
        <img src="${p.image}">
        <div class="product-info">
          <h3>${p.name}</h3>
          <p>‚Çπ${p.price}</p>
        </div>
        <div class="actions">
          <button class="edit-btn"
            onclick="openEdit(
              '${docSnap.id}',
              '${p.name}',
              '${p.price}',
              '${p.image}',
              '${p.publicId || ""}'
            )">
            Edit
          </button>
          <button class="delete-btn"
            onclick="deleteProduct(
              '${docSnap.id}',
              '${p.publicId || ""}'
            )">
            Delete
          </button>
        </div>
      </div>
    `;
    });
  }
  
  /* ---------------- OPEN EDIT ---------------- */
  window.openEdit = (id, name, price, image, publicId) => {
    currentId = id;
    currentPublicId = publicId;
    
    editName.value = name;
    editPrice.value = price;
    previewImg.src = image;
    
    editModal.classList.add("active");
  };
  
  /* ---------------- CLOSE EDIT ---------------- */
  window.closeEdit = () => {
    editModal.classList.remove("active");
  };
  
  /* ---------------- SAVE EDIT (NO IMAGE CHANGE) ---------------- */
  window.saveEdit = async () => {
    const name = editName.value.trim();
    const price = editPrice.value.trim();
    
    if (!name || !price) {
      showAlert("Please fill all fields");
      return;
    }
    
    try {
      await updateDoc(doc(db, "products", currentId), {
        name,
        price: Number(price)
      });
      
      showAlert("Product updated");
      closeEdit();
      loadProducts();
      
    } catch (err) {
      console.error(err);
      showAlert("Update failed");
    }
  };
  
  /* ---------------- DELETE PRODUCT (SAFE) ---------------- */
  window.deleteProduct = async (id, publicId) => {
    try {
      // 1Ô∏è‚É£ Try deleting image (only if publicId exists)
      if (publicId) {
        const deleteImage = httpsCallable(functions, "deleteImage");
        await deleteImage({ publicId });
      }
      
      // 2Ô∏è‚É£ Always delete Firestore document
      await deleteDoc(doc(db, "products", id));
      
      showAlert("Product deleted");
      loadProducts();
      
    } catch (err) {
      console.error(err);
      showAlert("Product deleted (image already removed)");
      loadProducts();
    }
  };
  
  /* ---------------- INIT ---------------- */
  loadProducts();
</script>
</body>
</html>